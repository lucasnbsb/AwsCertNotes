# ELB - Elastic Load Balancer

_High-Availability_: At least 2 AZs are involved, the goal is to survive a data center loss

- Spreads the load
- Single point of DNS access
- SSL termination (HTTPS)
- Spearate public and private traffic
- Handle Failure
- Perform Health Checks
  - Done on a port and route, checks a http 200 return

_ELB is a managed load balancer_

- Automatically integrates with most services

AWS provides 4 kinds of Load Balancer

- CLB: classic load balancer (deprecated)
- ALB: application load balancer (layer 7)
- NLB: network load balancer 2017
- GLB: Gateway load balancer 2020: operates at layer 3 (ip)

_Security_: point the SG from the instances to only allow from the LB
users <-> LB <-> EC2

### ALB

Layer 7: HTTP

- balances within the same machine
- route based on
  - path
  - hostname
  - Query string
  - headers
- Fixed hostname
- aplication serverzs don't see the ip
- performs connection termination
  - real ip goes in the X-Forwarded-For Header, also port and proto
- Great for micro-services and container based apps
- you can choose different AZ for the same load balancer

#### Target Groups (where the traffic is going to be sent)

- EC2 Instances
- ECS tasks
- Lambda Functions
- Private Ip Addresses
  _Health checks is done on the taget group level_

### NLB - Network Load Balancer

- Layer 4 -> TCP | UDP
- Extremely high performance
- No free tier
- One static IP per AZ, supports elastic IP

Same as ALB - create Security Groups and redirect traffic to the LB

- Can point to EC2 instances or IP addresses
- It's possible to have a NLB in front of a ALB to get the best of both worlds

**Health check**

- TCP
- HTTP
- HTTPS

### GWLB - Gateway Load Balancer

- To use 3rd party security appliances, Usually to inspect traffic first
- Acts as a checkpoint for your traffic
- Uses **GENEVE** protocol on port **6081**
- Combines
  - TNG - Transparent Network Gateway
  - Load Balancer

**Targets**

- EC2 instances
- IP addresses

### Sticky Sessions | Session Affinity

_Stickyness can be enabled in the security groups_

- Same client, same instance. Requests stick to instances
  - Supported by
    - CLB
    - ALB
      - Because it's done via Session Cookie
- May cause imbalances on load
- The Cookie
  - Application based
    - Application
      - Generated by the LB
      - Named **AWSALBBAPP**
    - Custom
      - Generated by the app
      - include custom attributes
      - Can have any name but the reserved ones
  - Duration Based
    - Generated by the LB
    - Name is **AWSALB** (for ALB) or **AWSELB** ( for classic)

| Cross Zone LB                                                 | No Cross Zone                                                |
| ------------------------------------------------------------- | ------------------------------------------------------------ |
| Traffic gets distributed evenly across all instances          | Each AZ gets it's share no matter how many instances on each |
| **ALB** Enabled by default (no charges for inter AZ data)     |                                                              |
| **NLB** & **GWLB** disabled by default (charges for inter AZ) |                                                              |

### SSL / TLS certificates in the ELB

_Allows in-flight encryption between your LB and your client_
TLS is the new version of SSL, (X.509 certifica)

- Managed using **ACM**
- You can create your own
- HTTPS Listener
  - Clients can use **SNI** Server Name Indication to specify the hostaname they reach

**SNI** How do you load multiple SSL certificates?

- you indicate the name of your hostname and the LB picks the certificate for the handshake
- Only ALB and NLB: multiple listeners with multiple certificates
- CLB -> Supports only one SSL

### Connection Draining CLB / Deregistration Delay ALB | NLB

- Some time to complete the in-flight requests while the instance is going down
- tells the ELB to not send connections to the draining instance
- you set the value in secconds
- base it on the mean request duration

## ASG Auto Scaling Group

- Scale Out | Scale In | free
- When paired to a load balancer all instances are associated
- Can perform your health checks on scaled instances
- Minimum Capacity > Desired Capacity > Maximun Capacity

Create via _Launch Template_

- Conatins:
  - AMI + type
  - User data
  - EBS volumes
  - Security Groups
  - SSH key pair
  - IAM roles
  - Network + subnet info
  - LB info

Basically everything you would need to create an instance yourself has to go into the template
because the ASG is going to be creating instances for you

_Auto Scaling_: you can set a cloudWatch alarm with a metric (ex: CPU) and trigger a scaling

The ASG keeps a log of scaling events and the metrics that trigger them

### Scaling Policies

Good metrics to scale on

- CPU%
- Request Count per Target
- Average Network In/Out
- Custom metrics on CloudWatch

_Scaling Cooldown 300s by default_: allows metrics to stabilize to prevent burst scaling (it's a debounce time)

#### Predictive scaling

- Uses an ML model to predict the scaling based on history

### Instance Refresh

_When you need to update all instances for a new template_

- You set a minimum healthy instance %
- ASG terminates old instances and creates new instances with the new template untill all are new
